<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peta Web Flores Timur</title>

    <!-- Libraries CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        body { padding: 0; margin: 0; }
        #map { height: calc(100vh - 56px); width: 100%; }
        .modal-body i { margin-right: 8px; }
        .legend-in-control { margin: 5px 0 5px 24px; font-size: 0.9em; }
        .legend-in-control strong { display: block; margin-bottom: 4px; }
        .legend-in-control .legend-item { display: flex; align-items: center; margin-bottom: 2px; }
        .legend-in-control i { width: 18px; height: 18px; margin-right: 6px; opacity: 0.8; border: 1px solid #777; }
        .legend-in-control i.road-line { border: none; background: red; width: 20px; display: inline-block; }
        .river-legend-line { display: inline-block; width: 20px; height: 2px; background-color: blue; margin-right: 8px; vertical-align: middle; }
        .toponimi-legend-dot { display: inline-block; width: 12px; height: 12px; background-color: #3388ff; border-radius: 50%; margin-right: 8px; vertical-align: middle; border: 1px solid white; outline: 1px solid #555; }
        .leaflet-control-search .form-control { width: 200px; }
        #suggestions-container { position: absolute; width: 100%; z-index: 1000; }
    </style>
</head>
<body>

    <!-- Navbar dengan menu Tentang -->
    <nav class="navbar navbar-expand-lg bg-success navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-map-fill"></i> Peta Flores Timur</a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">
                        <i class="bi bi-info-circle-fill"></i> Tentang
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <div id="map"></div>

    <!-- Modal Info Kecamatan -->
    <div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="infoModalLabel">Info</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="infoModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button></div>
    </div></div></div>

    <!-- Modal Tentang -->
    <div class="modal fade" id="aboutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tentang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Nama : Amanda Najwa Paramitha</p>
                    <p>NIM : 24/544991/SV/25586</p>
                    <p>Kelas : A</p>
                    <hr>
                    <p class="text-center text-muted small">SIG UGM 2024</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Inisialisasi
        const map = L.map('map', { zoomControl: false }).setView([-8.3444, 122.9812], 10);
        L.control.zoom({ position: 'topright' }).addTo(map);

        const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
        const modalTitle = document.getElementById('infoModalLabel');
        const modalBody = document.getElementById('infoModalBody');
        let batasKecamatan, highlightedLayer = null;
        let districtNames = [];

        // 2. Custom Search Control
        L.Control.Search = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                container.innerHTML = `
                    <form class="d-flex p-2" id="search-form">
                        <input class="form-control me-2" type="search" id="search-input" placeholder="Cari Kecamatan..." autocomplete="off">
                        <button class="btn btn-success" type="submit"><i class="bi bi-search"></i></button>
                        <div id="suggestions-container" class="dropdown-menu"></div>
                    </form>
                `;
                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });
        new L.Control.Search({ position: 'topleft' }).addTo(map);

        // 3. Base Maps & Panes
        const baseMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
        map.createPane('kecamatanPane'); map.getPane('kecamatanPane').style.zIndex = 410;
        map.createPane('sungaiPane'); map.getPane('sungaiPane').style.zIndex = 415;
        map.createPane('jalanPane'); map.getPane('jalanPane').style.zIndex = 420;
        map.createPane('toponimiPane'); map.getPane('toponimiPane').style.zIndex = 430;
        const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
        const baseMaps = { "OpenStreetMap": baseMap, "Esri Satellite": esriSatellite };

        // Fungsi-fungsi style
        function getColor(p) { return p > 20000 ? '#8c5a1b' : p > 12000 ? '#d1954d' : '#f3b267'; }
        const highlightStyle = { weight: 5, color: '#FFFF00', dashArray: '' };
        function styleKecamatan(feature) { return { fillColor: getColor(feature.properties.Penduduk), weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7 }; }

        // 4. Memuat Layers
        Promise.all([
            fetch('DATA/batas_kecamatan.geojson').then(res => res.json()),
            fetch('DATA/jalan.geojson').then(res => res.json()),
            fetch('DATA/sungai.geojson').then(res => res.json()),
            fetch('DATA/toponimi.geojson').then(res => res.json())
        ]).then(([kecamatanData, jalanData, sungaiData, toponimiData]) => {

            batasKecamatan = L.geoJSON(kecamatanData, {
                style: styleKecamatan,
                pane: 'kecamatanPane',
                onEachFeature: function(feature, layer) {
                    districtNames.push(feature.properties.WADMKC);
                    const props = feature.properties;
                    if (props && props.WADMKC) {
                        layer.bindTooltip(props.WADMKC, { sticky: true });
                        layer.on('click', function(e) {
                            modalTitle.textContent = props.WADMKC;
                            modalBody.innerHTML = `<i class="bi bi-people-fill"></i><strong>Total Penduduk:</strong> ${props.Penduduk.toLocaleString('id-ID')}`;
                            infoModal.show();
                        });
                    }
                }
            });

            const jalan = L.geoJSON(jalanData, { style: f => ({ color: 'red', weight: f.properties.NAMA_UNSUR === 'Jalan Propinsi' ? 4 : f.properties.NAMA_UNSUR === 'Jalan Kabupaten' ? 2.5 : 1.5 }), pane: 'jalanPane' });
            const sungai = L.geoJSON(sungaiData, { style: { color: 'blue', weight: 1.5 }, pane: 'sungaiPane', onEachFeature: (f, l) => { if (f.properties.Shape_Leng) l.bindPopup(`<strong>Panjang:</strong> ${f.properties.Shape_Leng.toFixed(5)}`); } });
            const toponimi = L.geoJSON(toponimiData, { pane: 'toponimiPane', onEachFeature: (f, l) => { if (f.properties.NAMOBJ) l.bindPopup(f.properties.NAMOBJ); } });

            let pLegend = '<div class="legend-in-control"><strong>Jml. Penduduk</strong>';
            [0, 12000, 20000].forEach((g, i, a) => { pLegend += `<div class="legend-item"><i style="background:${getColor(g + 1)}"></i><span>${g.toLocaleString('id-ID')}${a[i+1] ? '&ndash;' + a[i+1].toLocaleString('id-ID') : '+'}</span></div>`; });
            pLegend += '</div>';

            let jLegend = '<div class="legend-in-control"><strong>Jenis Jalan</strong>';
            Object.entries({ 'Jalan Propinsi': 4, 'Jalan Kabupaten': 2.5, 'Jalan Lain': 1.5 }).forEach(([t, w]) => { jLegend += `<div class="legend-item"><i class="road-line" style="height:${w}px;"></i><span>${t}</span></div>`; });
            jLegend += '</div>';

            const overlayMaps = {
                [`Batas Kecamatan ${pLegend}`]: batasKecamatan,
                [`Jalan ${jLegend}`]: jalan,
                [`<i class='river-legend-line'></i> Sungai`]: sungai,
                [`<i class='toponimi-legend-dot'></i> Toponimi`]: toponimi
            };

            batasKecamatan.addTo(map);
            L.control.layers(baseMaps, overlayMaps, { collapsed: window.innerWidth <= 768 }).addTo(map);

        }).catch(error => console.error("Gagal memuat layer:", error));

        // 5. Logika Pencarian & Saran
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const suggestionsContainer = document.getElementById('suggestions-container');

        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            suggestionsContainer.innerHTML = '';
            if (query.length < 2) { suggestionsContainer.classList.remove('show'); return; }
            const filteredNames = districtNames.filter(name => name.toLowerCase().startsWith(query));
            if (filteredNames.length > 0) {
                filteredNames.forEach(name => {
                    const item = document.createElement('a');
                    item.classList.add('dropdown-item');
                    item.href = '#';
                    item.textContent = name;
                    suggestionsContainer.appendChild(item);
                });
                suggestionsContainer.classList.add('show');
            } else {
                suggestionsContainer.classList.remove('show');
            }
        });

        suggestionsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('dropdown-item')) {
                e.preventDefault();
                searchInput.value = e.target.textContent;
                suggestionsContainer.classList.remove('show');
                searchForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });

        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const query = searchInput.value.trim().toLowerCase();
            if (!query || !batasKecamatan) return;
            let foundLayer = null;
            batasKecamatan.eachLayer(layer => { if (layer.feature.properties.WADMKC.toLowerCase() === query) foundLayer = layer; });
            if (highlightedLayer) {
                try { batasKecamatan.resetStyle(highlightedLayer); } catch (e) { console.log("Could not reset style"); }
            }
            if (foundLayer) {
                map.flyToBounds(foundLayer.getBounds());
                foundLayer.setStyle(highlightStyle);
                highlightedLayer = foundLayer;
            } else {
                alert('Kecamatan tidak ditemukan!');
            }
        });

        document.addEventListener('click', function(e) {
            if (!searchForm.contains(e.target)) suggestionsContainer.classList.remove('show');
        });

    </script>

</body>
</html>